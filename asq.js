/*! asynquence
    v0.2.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
(function(e,t,n){typeof module!="undefined"&&module.exports?module.exports=n():typeof define=="function"&&define.amd?define(n):t[e]=n(e,t)})("ASQ",this,function(e,t){function s(e){return typeof setImmediate!="undefined"?setImmediate(e):setTimeout(e,0)}function o(){function e(){function e(){clearTimeout(S),S=null,y.length=0,b.length=0,w.length=0,E.length=0}function t(){if(m)return r();S||(S=s(r))}function r(){var r,i;S=null;if(m)e();else if(v)while(b.length){r=b.shift();try{r.apply(r,E)}catch(s){n.isMessageWrapper(s)?E=E.concat(s):(E.push(s),s.stack&&E.push(s.stack)),b.length===0&&console.error.apply(console,E)}}else if(g&&y.length>0){g=!1,r=y.shift(),i=w.slice(),w.length=0,i.unshift(o());try{r.apply(r,i)}catch(s){n.isMessageWrapper(s)?E=E.concat(s):E.push(s),v=!0,t()}}}function o(){function e(){if(v||m||g)return;g=!0,w.push.apply(w,arguments),E.length=0,t()}return e.fail=function(){if(v||m||g)return;v=!0,w.length=0,E.push.apply(E,arguments),t()},e.abort=function(){if(v||m)return;g=!1,m=!0,w.length=0,E.length=0,t()},e}function u(e,t,r){function o(){clearTimeout(E),E=y=b=w=null}function u(){if(h)return a();E||(E=s(a))}function a(){if(v||m||p)return;var t=[];E=null,c?(e.fail.apply(e,w),o()):h?(e.abort(),o()):f()&&(p=!0,y.forEach(function(e,n){t.push(b["s"+n])}),e.apply(e,t),o())}function f(){if(v||m||c||h||p||y.length===0)return;var e=!0;return y.some(function(t){if(t===null)return e=!1,!0}),e}function l(){function e(){if(v||m||c||h||p||y[t])return;var e=n.messages.apply(null,arguments);b["s"+t]=e.length>1?e:e[0],y[t]=!0,u()}var t=y.length;return e.fail=function(){if(v||m||c||h||p||y[t])return;c=!0,w=i.call(arguments),u()},e.abort=function(){if(v||m||c||h||p)return;h=!0,a()},y[t]=null,e}var c=!1,h=!1,p=!1,d,g,y=[],b={},w,E;t.some(function(e){if(c||h)return!0;d=r.slice(),d.unshift(l());try{e.apply(e,d)}catch(t){return g=t,c=!0,!0}}),g&&(n.isMessageWrapper(g)?e.fail.apply(null,g):e.fail(g))}function a(){return v||m?x:(arguments.length>0&&y.push.apply(y,arguments),t(),x)}function f(){return m?x:(b.push.apply(b,arguments),t(),x)}function l(){if(v||m||arguments.length===0)return x;var e=i.call(arguments);return a(function(t){var n=i.call(arguments,1);u(t,e,n)}),x}function c(){return v||m||arguments.length===0?x:(i.call(arguments).forEach(function(e){a(function(t){e.apply(e,i.call(arguments,1)),t()}).or(e.fail)}),x)}function h(){return v||m||arguments.length===0?x:(i.call(arguments).forEach(function(e){a(function(t){e.apply(e,i.call(arguments,1)).pipe(t)})}),x)}function p(){return v||m||arguments.length===0?x:(i.call(arguments).forEach(function(e){a(function(t){var r=e.apply(e,i.call(arguments,1));n.isMessageWrapper(r)||(r=n.messages.call(null,r)),t.apply(t,r)})}),x)}function d(){return v?x:(m=!0,r(),x)}var v=!1,m=!1,g=!0,y=[],b=[],w=[],E=[],S,x={then:a,or:f,gate:l,pipe:c,seq:h,val:p,abort:d};return arguments.length>0&&x.then.apply(x,arguments),x}return e}var n,r=(t||{})[e],i=Array.prototype.slice;return n=o(),n.messages=function(){var e=i.call(arguments);return Object.defineProperty(e,"__ASQ__",{enumerable:!1,value:!0}),e},n.isMessageWrapper=function(e){return typeof e=="object"&&e.__ASQ__},n.noConflict=function(){return t&&(t[e]=r),n},n});
