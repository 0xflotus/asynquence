/*! asynquence
    v0.2.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
(function(n,e,t){if(typeof module!=="undefined"&&module.exports)module.exports=t();else if(typeof define==="function"&&define.amd)define(t);else e[n]=t(n,e)})("ASQ",this,function(n,e){var t,r=(e||{})[n],u=Array.prototype.slice,l="__ASQ__";function f(n){return typeof setImmediate!=="undefined"?setImmediate(n):setTimeout(n,0)}function i(){function n(){clearTimeout(T);T=null;E.length=0;_.length=0;A.length=0;S.length=0}function e(){if(v)return r();if(!T){T=f(r)}}function r(){var t,r;T=null;if(v){n()}else if(d){while(_.length){t=_.shift();try{t.apply(t,S)}catch(u){if(s(u)){S=S.concat(u)}else{S.push(u);if(u.stack)S.push(u.stack)}if(_.length===0){console.error.apply(console,S)}}}}else if(b&&E.length>0){b=false;t=E.shift();r=A.slice();A.length=0;r.unshift(l());try{t.apply(t,r)}catch(u){if(s(u)){S=S.concat(u)}else{S.push(u)}d=true;e()}}}function l(){function n(){if(d||v||b)return;b=true;A.push.apply(A,arguments);S.length=0;e()}n.fail=function(){if(d||v||b)return;d=true;A.length=0;S.push.apply(S,arguments);e()};n.abort=function(){if(d||v)return;b=false;v=true;A.length=0;S.length=0;e()};return n}function i(n,e,r){function l(){clearTimeout(A);A=b=E=_=null}function i(){if(g)return a();if(!A){A=f(a)}}function a(){if(d||v||h)return;var e=[];A=null;if(p){n.fail.apply(n,_);l()}else if(g){n.abort();l()}else if(c()){h=true;b.forEach(function(n,t){e.push(E["s"+t])});n.apply(n,e);l()}}function c(){if(d||v||p||g||h||b.length===0)return;var n=true;b.some(function(e){if(e===null){n=false;return true}});return n}function o(){function n(){if(d||v||p||g||h||b[e]){return}var n=t.messages.apply(null,arguments);E["s"+e]=n.length>1?n:n[0];b[e]=true;i()}var e=b.length;n.fail=function(){if(d||v||p||g||h||b[e]){return}p=true;_=u.call(arguments);i()};n.abort=function(){if(d||v||p||g||h)return;g=true;a()};b[e]=null;return n}var p=false,g=false,h=false,m,y,b=[],E={},_,A;e.some(function(n){if(p||g)return true;m=r.slice();m.unshift(o());try{n.apply(n,m)}catch(e){y=e;p=true;return true}});if(y){if(s(y)){n.fail.apply(null,y)}else{n.fail(y)}}}function c(){if(d||v||arguments.length===0)return j;E.push.apply(E,arguments);e();return j}function o(){if(v||arguments.length===0)return j;_.push.apply(_,arguments);e();return j}function p(){if(d||v||arguments.length===0)return j;var n=u.call(arguments);c(function(e){var t=u.call(arguments,1);i(e,n,t)});return j}function g(){if(v||arguments.length===0)return j;u.call(arguments).forEach(function(n){c(function(e){n.apply(n,u.call(arguments,1));e()}).or(n.fail)});return j}function h(){if(d||v||arguments.length===0)return j;u.call(arguments).forEach(function(n){c(function(e){if(!s(n)){n=n.apply(n,u.call(arguments,1))}n.pipe(e)})});return j}function m(){if(d||v||arguments.length===0)return j;u.call(arguments).forEach(function(n){c(function(e){var r=n.apply(n,u.call(arguments,1));if(!s(r)){r=t.messages.call(null,r)}e.apply(e,r)})});return j}function y(){if(d)return j;v=true;r();return j}var d=false,v=false,b=true,E=[],_=[],A=[],S=[],T,j=a({then:c,or:o,gate:p,pipe:g,seq:h,val:m,abort:y});j.then.apply(j,arguments);return j}t=i();t.messages=function(){var n=u.call(arguments);a(n);return n};function a(n){Object.defineProperty(n,l,{enumerable:false,value:true});return n}function s(n){return typeof n==="object"&&n[l]}t.isMessageWrapper=t.isSequence=s;t.noConflict=function(){if(e){e[n]=r}return t};return t});
