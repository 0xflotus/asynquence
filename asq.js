/*! asynquence
    v0.2.0-a (c) Kyle Simpson
    MIT License: http://getify.mit-license.org
*/
(function(e,t,n){typeof module!="undefined"&&module.exports?module.exports=n():typeof define=="function"&&define.amd?define(n):t[e]=n(e,t)})("ASQ",this,function(e,t){function o(e){return typeof setImmediate!="undefined"?setImmediate(e):setTimeout(e,0)}function u(){function e(){function e(){clearTimeout(T),T=null,w.length=0,E.length=0,S.length=0,x.length=0}function t(){if(y)return r();T||(T=o(r))}function r(){var n,r;T=null;if(y)e();else if(g)while(E.length){n=E.shift();try{n.apply(n,x)}catch(i){f(i)?x=x.concat(i):(x.push(i),i.stack&&x.push(i.stack)),E.length===0&&console.error.apply(console,x)}}else if(b&&w.length>0){b=!1,n=w.shift(),r=S.slice(),S.length=0,r.unshift(s());try{n.apply(n,r)}catch(i){f(i)?x=x.concat(i):x.push(i),g=!0,t()}}}function s(){function e(){if(g||y||b)return;b=!0,S.push.apply(S,arguments),x.length=0,t()}return e.fail=function(){if(g||y||b)return;g=!0,S.length=0,x.push.apply(x,arguments),t()},e.abort=function(){if(g||y)return;b=!1,y=!0,S.length=0,x.length=0,t()},e}function u(e,t,r){function s(){clearTimeout(S),S=b=w=E=null}function u(){if(p)return a();S||(S=o(a))}function a(){if(g||y||d)return;var t=[];S=null,h?(e.fail.apply(e,E),s()):p?(e.abort(),s()):l()&&(d=!0,b.forEach(function(e,n){t.push(w["s"+n])}),e.apply(e,t),s())}function l(){if(g||y||h||p||d||b.length===0)return;var e=!0;return b.some(function(t){if(t===null)return e=!1,!0}),e}function c(){function e(){if(g||y||h||p||d||b[t])return;var e=n.messages.apply(null,arguments);w["s"+t]=e.length>1?e:e[0],b[t]=!0,u()}var t=b.length;return e.fail=function(){if(g||y||h||p||d||b[t])return;h=!0,E=i.call(arguments),u()},e.abort=function(){if(g||y||h||p||d)return;p=!0,a()},b[t]=null,e}var h=!1,p=!1,d=!1,v,m,b=[],w={},E,S;t.some(function(e){if(h||p)return!0;v=r.slice(),v.unshift(c());try{e.apply(e,v)}catch(t){return m=t,h=!0,!0}}),m&&(f(m)?e.fail.apply(null,m):e.fail(m))}function l(){return g||y||arguments.length===0?N:(w.push.apply(w,arguments),t(),N)}function c(){return y||arguments.length===0?N:(E.push.apply(E,arguments),t(),N)}function h(){if(g||y||arguments.length===0)return N;var e=i.call(arguments);return l(function(t){var n=i.call(arguments,1);u(t,e,n)}),N}function p(){return y||arguments.length===0?N:(i.call(arguments).forEach(function(e){l(function(t){e.apply(e,i.call(arguments,1)),t()}).or(e.fail)}),N)}function d(){return g||y||arguments.length===0?N:(i.call(arguments).forEach(function(e){l(function(t){f(e)||(e=e.apply(e,i.call(arguments,1))),e.pipe(t)})}),N)}function v(){return g||y||arguments.length===0?N:(i.call(arguments).forEach(function(e){l(function(t){var r=e.apply(e,i.call(arguments,1));f(r)||(r=n.messages.call(null,r)),t.apply(t,r)})}),N)}function m(){return g?N:(y=!0,r(),N)}var g=!1,y=!1,b=!0,w=[],E=[],S=[],x=[],T,N=a({then:l,or:c,gate:h,pipe:p,seq:d,val:v,abort:m});return N.then.apply(N,arguments),N}return e}function a(e){return Object.defineProperty(e,s,{enumerable:!1,value:!0}),e}function f(e){return typeof e=="object"&&e[s]}var n,r=(t||{})[e],i=Array.prototype.slice,s="__ASQ__";return n=u(),n.messages=function(){var e=i.call(arguments);return a(e),e},n.isMessageWrapper=n.isSequence=f,n.noConflict=function(){return t&&(t[e]=r),n},n});
